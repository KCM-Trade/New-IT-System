## 金融交易系统前端开发指南

### 项目架构概览
- **技术栈**: React 18 + TypeScript + Vite + Tailwind CSS + shadcn/ui
- **状态管理**: React Hooks (useState, useCallback, useMemo)
- **UI组件**: shadcn/ui 组件库，遵循现代金融界面设计规范
- **路由**: React Router v6，支持懒加载
- **构建工具**: Vite (开发服务器 + 生产构建)

### 核心文件职责
```
src/
├── components/
│   ├── app-sidebar.tsx     # 侧边栏导航定义
│   ├── site-header.tsx     # 页面标题映射
│   └── ui/                 # shadcn/ui组件库
├── pages/                  # 页面组件
├── App.tsx                 # 路由注册
└── main.tsx               # 应用入口
```

## 标准筛选卡片组件设计

### 设计规范
- **响应式布局**: 桌面端筛选项同行，移动端自动换行
- **控件规格**: 统一高度 `h-9`，按钮内边距 `px-3`，选择器宽度 `w-36`
- **交互模式**: 显式触发分析，避免实时查询造成性能问题
- **状态管理**: 集中状态，支持条件渲染和加载状态

### 核心状态定义
```tsx
// 对象筛选规则类型
type Rule = 
  | { type: "customer_ids"; ids: number[]; include: boolean }
  | { type: "customer_tags"; source: "local" | "crm"; tags: string[]; operator: "ANY" | "ALL"; include: boolean }
  | { type: "account_ids"; ids: string[]; include: boolean }

// 筛选状态
const [rules, setRules] = useState<Rule[]>([])
const [startDate, setStartDate] = useState<Date | undefined>(new Date())
const [endDate, setEndDate] = useState<Date | undefined>(new Date())
const [quickRange, setQuickRange] = useState<"last_1w" | "last_1m" | "last_3m" | "all" | "custom">("last_1m")
const [symbolsMode, setSymbolsMode] = useState<"all" | "custom">("all")
const [selectedSymbols, setSelectedSymbols] = useState<string[]>([])

// 分析状态
const [isAnalyzing, setIsAnalyzing] = useState(false)
const [analysisData, setAnalysisData] = useState<any>(null)
const [analysisError, setAnalysisError] = useState<string | null>(null)
```

### 响应式布局结构
```tsx
<Card>
  <CardHeader>
    <CardTitle>筛选</CardTitle>
  </CardHeader>
  <CardContent className="space-y-4">
    {/* 筛选项区域 - 响应式布局 */}
    <div className="flex flex-wrap items-center justify-between gap-3">
      <div className="flex flex-wrap items-center gap-3">
        {/* 对象选择 - 响应式 Dialog/Drawer */}
        <div className="flex items-center gap-2">
          <span className="text-sm text-muted-foreground">选择对象：</span>
          <div className="hidden sm:block">
            <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
              <DialogTrigger asChild>
                <Button variant="outline" className="h-9 px-3">选择对象</Button>
              </DialogTrigger>
              {/* Dialog内容 */}
            </Dialog>
          </div>
          <div className="block sm:hidden">
            <Drawer open={drawerOpen} onOpenChange={setDrawerOpen}>
              {/* Drawer内容 */}
            </Drawer>
          </div>
        </div>

        {/* 时间范围 - 双日历 + 快捷选择 */}
        <div className="flex items-center gap-2">
          <span className="text-sm text-muted-foreground">时间范围：</span>
          <Popover>
            <PopoverTrigger asChild>
              <Button variant="outline" className="h-9 px-3 min-w-[140px]">{rangeLabel}</Button>
            </PopoverTrigger>
            <PopoverContent>
              {/* 双日历布局 */}
            </PopoverContent>
          </Popover>
          <Select value={quickRange} onValueChange={applyQuickRange}>
            <SelectTrigger className="h-9 w-36">快捷范围</SelectTrigger>
          </Select>
        </div>

        {/* 交易品种 */}
        <div className="flex items-center gap-2">
          <span className="text-sm text-muted-foreground">交易品种：</span>
          <Select value={symbolsMode} onValueChange={setSymbolsMode}>
            <SelectTrigger className="h-9 w-36">选择方式</SelectTrigger>
          </Select>
        </div>
      </div>

      {/* 分析按钮 - 桌面端右对齐 */}
      <div className="hidden sm:flex">
        <Button onClick={handleAnalyzeData} className="h-9 gap-2" disabled={isAnalyzing}>
          {isAnalyzing ? <Loader2 className="size-4 animate-spin" /> : <Search className="size-4" />}
          {isAnalyzing ? "分析中..." : "开始分析"}
        </Button>
      </div>
    </div>

    {/* 移动端分析按钮 - 独立行居中 */}
    <div className="flex justify-center sm:hidden">
      <Button onClick={handleAnalyzeData} className="h-9 gap-2" disabled={isAnalyzing}>
        {/* 同上 */}
      </Button>
    </div>
  </CardContent>
</Card>

{/* 条件渲染分析结果 */}
{(analysisData || isAnalyzing) && (
  <div className="grid grid-cols-1 gap-4 md:grid-cols-3 lg:grid-cols-5">
    {/* KPI卡片 + 图表区域 */}
  </div>
)}
```

### 关键交互逻辑
```tsx
// 时间快捷范围处理
const applyQuickRange = useCallback((qr: typeof quickRange) => {
  const today = new Date()
  const d0 = new Date(today.getFullYear(), today.getMonth(), today.getDate())
  
  if (qr === "all") {
    setStartDate(undefined)
    setEndDate(undefined)
  } else if (qr === "last_1m") {
    const s = new Date(d0)
    s.setMonth(s.getMonth() - 1)
    s.setDate(s.getDate() + 1)
    setStartDate(s)
    setEndDate(d0)
  }
  setQuickRange(qr)
}, [])

// 分析数据处理
const handleAnalyzeData = useCallback(async () => {
  if (effectiveAccounts.length === 0) return
  
  setIsAnalyzing(true)
  setAnalysisError(null)
  
  try {
    const analysisParams = {
      accounts: effectiveAccounts,
      startDate: quickRange === "all" ? undefined : startDate,
      endDate: quickRange === "all" ? undefined : endDate,
      symbols: symbolsMode === "all" ? null : selectedSymbols
    }
    
    const result = await postAnalysisRequest(analysisParams)
    setAnalysisData(result)
  } catch (error: any) {
    setAnalysisError(error?.message ?? "分析失败")
  } finally {
    setIsAnalyzing(false)
  }
}, [effectiveAccounts, quickRange, startDate, endDate, symbolsMode, selectedSymbols])
```

### 设计要点
- **响应式断点**: `sm:` (640px) 作为桌面/移动分界
- **加载状态**: 使用 `Loader2` 图标 + `animate-spin` 类
- **禁用逻辑**: 未选择账户时禁用分析按钮
- **条件渲染**: 只在有数据或加载中时显示结果区域
- **骨架屏**: 加载中显示带动画的占位内容

## 页面管理操作

### 1. 新增页面（完整流程）
```tsx
// 1. 创建页面组件
// src/pages/YourPage.tsx
export default function YourPage() {
  return <div>Your Page Content</div>
}

// 2. 注册路由 - App.tsx
const YourPage = lazy(() => import("@/pages/YourPage"))
// 在 Routes 中添加
<Route path="/your-path" element={<YourPage />} />

// 3. 添加标题映射 - site-header.tsx
const titleMap: Record<string, string> = {
  "/your-path": "你的页面标题",
}

// 4. 添加到侧边栏 - app-sidebar.tsx
const data = {
  navMain: [
    { title: "你的页面标题", url: "/your-path", icon: IconReport },
  ]
}
```

### 2. 隐藏/删除页面
```tsx
// 隐藏：从 app-sidebar.tsx 中删除条目（保留路由）
// 删除：同时从 App.tsx 移除路由和 site-header.tsx 移除标题
```

## API 调用规范

### 标准请求封装
```tsx
// POST 请求
async function postJson<T>(url: string, body: unknown, signal?: AbortSignal): Promise<T> {
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json", accept: "application/json" },
    body: JSON.stringify(body),
    signal,
  })
  if (!res.ok) throw new Error(`HTTP ${res.status}`)
  return (await res.json()) as T
}

// 使用示例
const handleAnalyze = useCallback(async () => {
  setIsLoading(true)
  try {
    const data = await postJson<AnalysisResponse>(
      "/api/v1/trading/analysis", 
      { accounts, startDate, endDate, symbols }
    )
    setResult(data)
  } catch (error: any) {
    if (error?.name !== "AbortError") setError(error.message)
  } finally {
    setIsLoading(false)
  }
}, [accounts, startDate, endDate, symbols])
```

### 关键约定
- **相对路径**: 统一使用 `/api/...`，避免硬编码主机地址
- **错误处理**: 检查 `res.ok`，捕获 `AbortError`
- **加载状态**: 统一管理 `loading/error/data` 状态
- **可取消请求**: 使用 `AbortController` 避免竞态条件

### 响应式对话框模式
```tsx
// 桌面端用 Dialog，移动端用 Drawer
<div className="hidden sm:block">
  <Dialog open={open} onOpenChange={setOpen}>
    <DialogContent className="w-[90vw] sm:max-w-[1100px]">
      {/* 内容 */}
    </DialogContent>
  </Dialog>
</div>
<div className="block sm:hidden">
  <Drawer open={open} onOpenChange={setOpen}>
    <DrawerContent>
      {/* 相同内容 */}
    </DrawerContent>
  </Drawer>
</div>
```

### 表格滚动处理
```tsx
// 单层滚动策略，避免双重滚动条
<div className="border rounded-md overflow-hidden">
  <div className="overflow-auto max-h-64">
    <Table className="min-w-[800px]">
      {/* 表格内容 */}
    </Table>
  </div>
</div>
```

## 参考实现
完整的筛选卡片实现可参考 `src/pages/ClientTradingAnalytics.tsx`，包含：
- 响应式对象选择弹层
- 双日历时间选择器
- 品种自定义添加
- 分析状态管理
- 条件渲染逻辑