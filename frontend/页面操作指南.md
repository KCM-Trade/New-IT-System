## 前端页面操作指南

### 文件职责速览
- **`src/components/app-sidebar.tsx`**: 定义侧边栏结构与条目（`title`/`url`/`icon`/`children`）。
- **`src/App.tsx`**: 注册页面路由（`react-router`），决定 URL → 页面组件。
- **`src/components/site-header.tsx`**: 路径到页面标题的映射（`titleMap`），并设置浏览器标签 `document.title`。

### 常见任务
#### 4) 在筛选卡片复用“对象/时间/品种”交互（可复制到任意页面）

```tsx
// 片段来自 `src/pages/ClientTradingAnalytics.tsx`，可按需复制：
// - 对象选择：Dialog/Drawer 响应式弹层，支持客户ID/账户号/IB/客户Tag 规则
// - 时间范围：按钮 + 弹层内“双日历（开始/结束）”，支持快捷范围（1周/1月/3月/全部/自定义）
// - 品种：全选或自定义，支持用户新增自定义品种并立即勾选

// 关键状态（可放到页面组件内）
type Rule =
  | { type: "customer_ids"; ids: number[]; include: boolean }
  | { type: "customer_tags"; source: "local" | "crm"; tags: string[]; operator: "ANY" | "ALL"; include: boolean }
  | { type: "account_ids"; ids: string[]; include: boolean }
  | { type: "ib_id"; id: number; depth: "all" | "level1" | "level1_2"; include: boolean }

const [rules, setRules] = React.useState<Rule[]>([])
const [startDate, setStartDate] = React.useState<Date | undefined>(new Date())
const [endDate, setEndDate] = React.useState<Date | undefined>(new Date())
const [quickRange, setQuickRange] = React.useState<"last_1w" | "last_1m" | "last_3m" | "all" | "custom">("last_1m")
const [symbolsMode, setSymbolsMode] = React.useState<"all" | "custom">("all")
const [selectedSymbols, setSelectedSymbols] = React.useState<string[]>([])
const [customSymbols, setCustomSymbols] = React.useState<string[]>([])
const [customSymbolInput, setCustomSymbolInput] = React.useState("")

// 快捷范围应用（可提取到 util）
const applyQuickRange = React.useCallback((qr: typeof quickRange) => {
  const today = new Date()
  const d0 = new Date(today.getFullYear(), today.getMonth(), today.getDate())
  if (qr === "all") {
    setStartDate(undefined)
    setEndDate(undefined)
    setQuickRange(qr)
    return
  }
  if (qr === "last_1w") {
    const s = new Date(d0)
    s.setDate(s.getDate() - 6)
    setStartDate(s)
    setEndDate(d0)
  } else if (qr === "last_1m") {
    const s = new Date(d0)
    s.setMonth(s.getMonth() - 1)
    s.setDate(s.getDate() + 1)
    setStartDate(s)
    setEndDate(d0)
  } else if (qr === "last_3m") {
    const s = new Date(d0)
    s.setMonth(s.getMonth() - 3)
    s.setDate(s.getDate() + 1)
    setStartDate(s)
    setEndDate(d0)
  }
  setQuickRange(qr)
}, [])

// 展示标签
const rangeLabel = React.useMemo(() => {
  if (quickRange === "all") return "全部历史"
  if (quickRange === "last_1w") return "最近 1 周"
  if (quickRange === "last_1m") return "最近 1 个月"
  if (quickRange === "last_3m") return "最近 3 个月"
  if (!startDate || !endDate) return "选择日期范围"
  const opts: Intl.DateTimeFormatOptions = { month: "short", day: "2-digit", year: "numeric" }
  return `${startDate.toLocaleDateString("en-US", opts)} - ${endDate.toLocaleDateString("en-US", opts)}`
}, [quickRange, startDate, endDate])

// 品种合并（内置 + 自定义）
const combinedSymbols = React.useMemo(() => Array.from(new Set([...sampleSymbols, ...customSymbols])), [customSymbols])

// UI 片段（时间）
// <Button>{rangeLabel}</Button> + <Calendar mode="single" captionLayout="dropdown" />（开始/结束各一个）
// 右侧 <Select> 提供快捷范围（1周/1月/3月/全部/自定义）

// UI 片段（品种）
// 自定义模式下在 Popover 中：列表 + <Input/> + “添加”按钮；支持全选/清空
```

说明要点：
- **双日历**：使用 `mode="single"`，`captionLayout="dropdown"` 允许快速选择年月；开始/结束互相纠错（开始>结束时自动调整另一个）。
- **快捷范围**：预设计算今天零点为结束，向前回溯并包含首尾；“全部历史”清空开始/结束以交由后端解释为不限制。
- **自定义品种**：规范为大写，去重后加入列表并默认勾选，便于快速试错。
- **摘要提示**：建议显示规则数、账户数、时间标签、品种选择摘要。

可直接参考并复用 `src/pages/ClientTradingAnalytics.tsx` 中的实现。

#### 1) 隐藏侧边栏的某个页面（不影响直达 URL）
编辑 `app-sidebar.tsx`，在 `data.navMain`（或某分组 `children`）中删除或注释该条目。

```tsx
// app-sidebar.tsx → data.navMain 中删除该对象
{ title: "黄金报价", url: "/gold", icon: IconReport },
```

说明：仅隐藏入口；若路由仍在 `App.tsx` 注册，直接访问 `/gold` 仍可打开。

#### 2) 新增一个页面（完整流程）
1. 创建页面：`src/pages/YourPage.tsx`，导出默认组件。
2. 注册路由（懒加载）：
```tsx
// App.tsx（顶部懒加载）
const YourPage = lazy(() => import("@/pages/YourPage"))
// App.tsx（路由）
<Route path="your-path" element={<YourPage />} />
```
3. 标题映射：
```tsx
// site-header.tsx → titleMap
"/your-path": "你的中文标题",
```
4. 加入侧边栏：
```tsx
// app-sidebar.tsx → data.navMain 中合适位置插入
{ title: "你的中文标题", url: "/your-path", icon: IconReport },
```

可选：放入分组（如“报仓数据”）时，改为加入该分组的 `children` 数组。

#### 3) 删除一个页面（完全移除）
1. 侧边栏：`app-sidebar.tsx` 删除该条目。
2. 路由：`App.tsx` 删除对应 `<Route />` 与 `lazy` 导入。
3. 标题：`site-header.tsx` 从 `titleMap` 删除对应键值。
4. 页面文件：删除 `src/pages/YourPage.tsx`（如不再需要）。

### 细节与提示
- 侧边栏激活态基于 `pathname.startsWith(item.url)`，`url` 适合作为前缀。
- `titleMap` 默认精确匹配键值；子路径若需不同标题，需新增键或改逻辑为前缀匹配。
- 分组菜单示例：`报仓数据` 使用 `children`；子项仅需 `{ title, url }`，但 `App.tsx` 必须存在对应 `<Route />`。




### API 调用规范（与项目现状保持一致）

- 使用相对路径（推荐）
  - **原因**：开发阶段由 Vite 代理或同源反代转发到后端，避免浏览器直连错误主机（如 `localhost` 指向本机导致连接拒绝）。
  - **约定**：统一用 `/api/...`，不要在代码里硬编码 `http://localhost:8001`。

- 请求头与错误处理
  - POST：`headers: { "Content-Type": "application/json", accept: "application/json" }`
  - GET：`headers: { accept: "application/json" }`
  - 检查 `res.ok`，失败抛出 `Error('HTTP ' + res.status)`；若响应体有 `{ ok, error }`，再判断业务 `ok` 并抛出 `error`。

- 可取消请求（避免并发/竞态）
  - 使用 `AbortController`；发起新请求前中止上一次。
  - 参考 `WarehouseProducts`/`ClientTradingAnalytics` 的实现。

- 触发时机与状态
  - 由显式交互触发（按钮点击 / 弹层打开），不要在组件 mount 时自动请求。
  - 统一管理 `loading/error/lastUpdated` 等状态；必要时展示进度条。

- 缓存约定
  - 查询结果或上次查询参数可放入 `sessionStorage`；表格列显示/顺序/页大小等放入 `localStorage`。

- 跨域与直连
  - 开发环境：优先走相对路径 + 代理；若必须直连（如无代理），在 `.env` 配置 `VITE_API_BASE=http://后端地址:8001` 并在封装里拼接。
  - 常见现象：“strict-origin-when-cross-origin” 仅是 Referrer-Policy，与 CORS 无直接关系；`ERR_CONNECTION_REFUSED` 多为直连到错误主机/端口。

- 最小示例（POST）
```ts
async function postJson<T>(url: string, body: unknown, signal?: AbortSignal): Promise<T> {
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json", accept: "application/json" },
    body: JSON.stringify(body),
    signal,
  })
  if (!res.ok) throw new Error(`HTTP ${res.status}`)
  return (await res.json()) as T
}

// 用法
const ctl = new AbortController()
try {
  const data = await postJson<{ ok: boolean; items: any[]; error?: string }>(
    "/api/v1/trade-summary/query",
    { date, symbol, mode: "refresh" },
    ctl.signal,
  )
  if (!data.ok) throw new Error(data.error || "unknown error")
  setItems(data.items)
} catch (e: any) {
  if (e?.name !== "AbortError") setError(e?.message || "请求失败")
}
```

- 最小示例（GET）
```ts
async function getJson<T>(url: string, signal?: AbortSignal): Promise<T> {
  const res = await fetch(url, { method: "GET", headers: { accept: "application/json" }, signal })
  if (!res.ok) throw new Error(`HTTP ${res.status}`)
  return (await res.json()) as T
}

// 用法
const items = await getJson<{ ok: boolean; items: any[]; error?: string }>(
  `/api/v1/open-positions/today?source=${source}`
)
```

- 组件级使用建议
  - 弹层（Dialog/Drawer）使用受控 `open/onOpenChange`，在打开时触发加载；避免“受控/非受控切换”警告。
  - 将“后端字段 → 前端行结构”的映射集中处理，表格列只关心展示。
