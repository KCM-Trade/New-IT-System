# Open Positions 实时头寸监控系统升级文档

## 1. 升级概述
本次升级将原有的多 Schema 分表查询逻辑整合为统一的**汇总表查询模式**，并新增了对 **MT5 服务器** 的支持以及**美分账户**的自动换算逻辑。同时，通过利用数据库索引字段优化了在大数据量下的查询性能。

## 2. 核心变动说明

### 2.1 后端变动 (Python Service)
- **数据库切换**：从 `mt4_live` / `mt4_live2` 的物理分库切换到 `fxbackoffice` 汇总库。
- **逻辑整合**：引入 `sid` 标识区分服务器（sid 1: MT4, 6: MT4Live2, 5: MT5）。
- **字段优化**：
    - **持仓量**：直接使用预计算的 `lots` 字段，统一了 MT4 和 MT5 的换算规则。
    - **盈亏统计**：切换为 `totalProfit`，该字段已包含 `Profit + Swaps + Commission`，提供更准确的财务视角。
- **美分账户兼容**：在 SQL 层自动识别 `*.kcmc` 和 `*.cent` 品种。若匹配，则自动将盈亏金额 `/ 100` 换算为美元。
- **性能提升**：查询条件从 `CLOSE_TIME` 变更为 `closeDate = '1970-01-01'`，利用了汇总表的存储列索引。

### 2.2 前端变动 (React / Position.tsx)
- **数据源扩展**：胶囊切换组件新增 `mt5` 选项，支持三服务器实时切换。
- **UI 描述增强**：将 Profit 列表头明确标记为 `Total Profit (Profit+Swap+Comm)`，降低用户的理解成本。
- **状态持久化**：支持在 `sessionStorage` 中记忆用户对 MT5 数据源的选择。

---

## 3. 对 Prod MySQL Slave 数据库的风险分析

将该服务运行在生产环境的从库（Slave DB）上，主要存在以下潜在风险：

### 3.1 复杂子查询性能风险 (`NOT EXISTS`)
- **风险点**：SQL 中使用了 `NOT EXISTS` 关联 `mt4_users` 来过滤测试账号。
- **分析**：虽然有索引，但在主表 `mt4_trades` 数据量极大（5000万+）且未平仓订单较多时，每一行结果都需要去 `mt4_users` 中检索。如果索引失效或缓存命中率低，会造成从库 **IO 压力骤增**。
- **建议**：定期检查 `mt4_users` 的 `loginSid` 索引是否健康。

### 3.2 从库延迟（Slave Lag）影响
- **风险点**：持仓数据对实时性要求极高。
- **分析**：如果主库正在执行大批量的历史数据清理或更新，导致从库产生秒级甚至分钟级的延迟，用户看到的“实时头寸”将是不准确的，可能导致错误的决策。
- **监控建议**：在前端或后端加入对 Slave 延迟时间的监控提示。

### 3.3 连接堆积风险
- **风险点**：目前代码采用短连接（每次请求建立一次连接）。
- **分析**：在高并发刷新（例如多名交易员同时频繁点击刷新按钮）的情况下，可能会占用大量的数据库连接数，甚至触发从库的 `max_connections` 限制。
- **建议**：后续考虑引入连接池或加入后端缓存（如 Redis），对 5-10 秒内的重复请求进行拦截。

### 3.4 全表扫描隐患
- **风险点**：虽然使用了 `closeDate` 索引，但如果统计逻辑被修改为非 1970 年的日期，索引效率会大幅下降。
- **结论**：当前逻辑（仅查 1970 年未平仓）是安全的，但需警惕未来业务需求的变更。

---

**文档日期**：2026-01-05
**版本**：v2.0 (Consolidated Edition)

