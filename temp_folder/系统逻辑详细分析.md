# å®¢æˆ·æ”¶ç›Šç‡åˆ†æç³»ç»Ÿ - è¯¦ç»†æŠ€æœ¯æ–‡æ¡£

## ç›®å½•
1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [app.py - FastAPIåç«¯æœåŠ¡](#apppy---fastapiåç«¯æœåŠ¡)
3. [fetch_mysql_pnl_v3.py - æ•°æ®è®¡ç®—æ ¸å¿ƒ](#fetch_mysql_pnl_v3py---æ•°æ®è®¡ç®—æ ¸å¿ƒ)
4. [æ•°æ®æµå›¾](#æ•°æ®æµå›¾)
5. [å…³é”®ä¸šåŠ¡é€»è¾‘è¯´æ˜](#å…³é”®ä¸šåŠ¡é€»è¾‘è¯´æ˜)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

æœ¬ç³»ç»Ÿç”±ä¸¤ä¸ªæ ¸å¿ƒæ–‡ä»¶ç»„æˆï¼š
- **app.py**: FastAPI WebæœåŠ¡å™¨ï¼Œæä¾›HTTP APIæ¥å£
- **fetch_mysql_pnl_v3.py**: æ•°æ®æå–å’Œè®¡ç®—è„šæœ¬ï¼Œä»MySQLæ•°æ®åº“æå–æ•°æ®å¹¶ç”ŸæˆCSVæŠ¥è¡¨

---

## app.py - FastAPIåç«¯æœåŠ¡

### æ–‡ä»¶ç»“æ„

```python
import glob
import os
import subprocess
import sys
from datetime import datetime

from fastapi import FastAPI, HTTPException
from fastapi.responses import FileResponse, JSONResponse
import uvicorn

PORT = 8111
DIRECTORY = os.path.dirname(os.path.abspath(__file__))

app = FastAPI()
```

### APIç«¯ç‚¹è¯¦ç»†è¯´æ˜

#### 1. GET / - è¿”å›å‰ç«¯é¡µé¢

```python
@app.get("/")
def index():
    return FileResponse(os.path.join(DIRECTORY, "index.html"))
```

**åŠŸèƒ½**: è¿”å›é™æ€HTMLå‰ç«¯é¡µé¢ï¼Œç”¨æˆ·é€šè¿‡æ­¤é¡µé¢ä¸ç³»ç»Ÿäº¤äº’

**è¿”å›**: `index.html` æ–‡ä»¶çš„HTTPå“åº”

---

#### 2. GET /api/files - åˆ—å‡ºæ‰€æœ‰CSVæŠ¥è¡¨æ–‡ä»¶

```python
@app.get("/api/files")
def list_files():
    csv_files = glob.glob(
        os.path.join(DIRECTORY, "account_pnl_with_client_metrics_*.csv")
    )
    csv_files.sort(key=os.path.getctime, reverse=True)
    file_info = []
    for f in csv_files:
        name = os.path.basename(f)
        ctime = os.path.getctime(f)
        file_info.append(
            {
                "name": name,
                "date": datetime.fromtimestamp(ctime).strftime("%Y-%m-%d %H:%M:%S"),
            }
        )
    return JSONResponse(file_info)
```

**åŠŸèƒ½**: 
- ä½¿ç”¨ `glob.glob()` æŸ¥æ‰¾æ‰€æœ‰åŒ¹é… `account_pnl_with_client_metrics_*.csv` çš„æ–‡ä»¶
- æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
- è¿”å›æ–‡ä»¶åå’Œåˆ›å»ºæ—¶é—´çš„JSONæ•°ç»„

**è¿”å›æ ¼å¼**:
```json
[
  {
    "name": "account_pnl_with_client_metrics_v3_20260102_143022.csv",
    "date": "2026-01-02 14:30:22"
  },
  ...
]
```

---

#### 3. GET /api/file/{filename} - ä¸‹è½½æŒ‡å®šCSVæ–‡ä»¶

```python
@app.get("/api/file/{filename}")
def get_file(filename: str):
    if not filename.startswith("account_pnl_with_client_metrics_") or not filename.endswith(".csv"):
        raise HTTPException(status_code=404, detail="File not found")
    file_path = os.path.join(DIRECTORY, filename)
    if not os.path.exists(file_path):
        raise HTTPException(status_code=404, detail="File not found")
    return FileResponse(file_path, media_type="text/csv")
```

**åŠŸèƒ½**:
- å®‰å…¨éªŒè¯ï¼šåªå…è®¸ä¸‹è½½ä»¥ `account_pnl_with_client_metrics_` å¼€å¤´ã€`.csv` ç»“å°¾çš„æ–‡ä»¶
- æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- è¿”å›CSVæ–‡ä»¶ä¾›ä¸‹è½½

**å®‰å…¨æœºåˆ¶**: é˜²æ­¢è·¯å¾„éå†æ”»å‡»ï¼Œåªå…è®¸è®¿é—®æŒ‡å®šå‰ç¼€çš„æ–‡ä»¶

---

#### 4. POST /api/run - è§¦å‘æ•°æ®æŸ¥è¯¢è„šæœ¬

```python
@app.post("/api/run")
def run_query():
    result = run_fetch_script()
    return JSONResponse(result)
```

**åŠŸèƒ½**: è§¦å‘æ‰§è¡Œæ•°æ®æå–è„šæœ¬ï¼Œç”Ÿæˆæ–°çš„CSVæŠ¥è¡¨

**è¿”å›æ ¼å¼**:
```json
{
  "success": true,
  "latest_file": "account_pnl_with_client_metrics_v3_20260102_143022.csv",
  "stdout": "è„šæœ¬è¾“å‡ºå†…å®¹...",
  "stderr": "é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰..."
}
```

---

### æ ¸å¿ƒå‡½æ•°è¯¦è§£

#### run_fetch_script() - æ‰§è¡Œæ•°æ®æå–è„šæœ¬

```python
def run_fetch_script():
    script_path = os.path.join(DIRECTORY, "fetch_mysql_pnl.py")
    try:
        # Use the same Python interpreter as the server (venv-safe).
        completed = subprocess.run(
            [sys.executable, script_path],
            cwd=DIRECTORY,
            capture_output=True,
            text=True,
            timeout=600,
        )
        latest_csv = get_latest_csv()
        return {
            "success": completed.returncode == 0,
            "latest_file": latest_csv["name"] if latest_csv else None,
            "stdout": completed.stdout,
            "stderr": completed.stderr,
        }
    except subprocess.TimeoutExpired:
        return {
            "success": False,
            "latest_file": None,
            "stdout": "",
            "stderr": "Query timeout: fetch_mysql_pnl.py took too long.",
        }
```

**å…³é”®ç‚¹**:
- ä½¿ç”¨ `sys.executable` ç¡®ä¿ä½¿ç”¨ç›¸åŒçš„Pythonè§£é‡Šå™¨ï¼ˆæ”¯æŒè™šæ‹Ÿç¯å¢ƒï¼‰
- `timeout=600` ç§’ï¼ˆ10åˆ†é’Ÿï¼‰è¶…æ—¶ä¿æŠ¤
- `capture_output=True` æ•è·æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯è¾“å‡º
- æ‰§è¡Œå®Œæˆåè‡ªåŠ¨è·å–æœ€æ–°ç”Ÿæˆçš„CSVæ–‡ä»¶

---

#### get_latest_csv() - è·å–æœ€æ–°CSVæ–‡ä»¶

```python
def get_latest_csv():
    csv_files = glob.glob(
        os.path.join(DIRECTORY, "account_pnl_with_client_metrics_*.csv")
    )
    if not csv_files:
        return None
    csv_files.sort(key=os.path.getctime, reverse=True)
    latest = csv_files[0]
    return {
        "name": os.path.basename(latest),
        "date": datetime.fromtimestamp(os.path.getctime(latest)).strftime(
            "%Y-%m-%d %H:%M:%S"
        ),
    }
```

**åŠŸèƒ½**: æŸ¥æ‰¾å¹¶è¿”å›æœ€æ–°åˆ›å»ºçš„CSVæ–‡ä»¶ä¿¡æ¯

---

### æœåŠ¡å™¨å¯åŠ¨

```python
if __name__ == "__main__":
    # Allow running via: python app.py
    uvicorn.run("app:app", host="0.0.0.0", port=PORT, reload=False)
```

**é…ç½®**:
- ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£ (`0.0.0.0`)
- ç«¯å£: 8111
- ä¸å¯ç”¨è‡ªåŠ¨é‡è½½ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

---

## fetch_mysql_pnl_v3.py - æ•°æ®è®¡ç®—æ ¸å¿ƒ

### æ–‡ä»¶ç»“æ„

```python
import os
from datetime import datetime

import mysql.connector
import pandas as pd
from dotenv import load_dotenv

# Load .env from current folder
env_path = os.path.join(os.path.dirname(__file__), ".env")
load_dotenv(env_path)
```

**ç¯å¢ƒé…ç½®**: ä»å½“å‰ç›®å½•çš„ `.env` æ–‡ä»¶åŠ è½½æ•°æ®åº“è¿æ¥ä¿¡æ¯

---

### ä¸»å‡½æ•° fetch_data() - å®Œæ•´æµç¨‹

#### æ­¥éª¤0: åˆå§‹åŒ–é…ç½®

```python
def fetch_data():
    # Basic DB config
    db_config = {
        "host": os.getenv("DB_HOST"),
        "user": os.getenv("DB_USER"),
        "password": os.getenv("DB_PASSWORD"),
        "port": int(os.getenv("DB_PORT", 3306)),
        "charset": os.getenv("DB_CHARSET", "utf8mb4"),
    }
    fxback_db = (
        os.getenv("FXBACK_DB_NAME", "fxbackoffice")
        .replace("'", "")
        .replace('"', "")
        .strip()
    )

    today = datetime.now().date()
    month_start = today.replace(day=1)
    today_str = today.strftime("%Y-%m-%d")
    month_start_str = month_start.strftime("%Y-%m-%d")
```

**è¯´æ˜**:
- ä»ç¯å¢ƒå˜é‡è¯»å–æ•°æ®åº“é…ç½®
- è®¡ç®—å½“å‰æ—¥æœŸå’Œæœ¬æœˆç¬¬ä¸€å¤©
- æ ¼å¼åŒ–æ—¥æœŸå­—ç¬¦ä¸²ç”¨äºSQLæŸ¥è¯¢

---

#### æ­¥éª¤1: æå–å®¢æˆ·å®æ—¶å‡€å€¼

```python
# --- Step 1: Current equity from mt4_users (real-time, exclude IB wallet) ---
print("ğŸ” [1/6] æ­£åœ¨æå–å®¢æˆ·å®æ—¶å‡€å€¼ (mt4_users)...")
equity_sql = f"""
SELECT
    userId AS client_id,
    SUM(CASE WHEN UPPER(currency) = 'CEN' THEN equity / 100.0 ELSE equity END) AS equity
FROM {fxback_db}.mt4_users
WHERE userId > 0
  AND sid IN (1, 5, 6)
GROUP BY userId
"""
df_equity = pd.read_sql(equity_sql, conn)
```

**SQLé€»è¾‘**:
- **æ•°æ®æº**: `mt4_users` è¡¨ï¼ˆMT4äº¤æ˜“è´¦æˆ·å®æ—¶æ•°æ®ï¼‰
- **å­—æ®µè¯´æ˜**:
  - `userId`: å®¢æˆ·ID
  - `equity`: è´¦æˆ·å‡€å€¼ï¼ˆå®æ—¶ï¼‰
  - `currency`: è´§å¸ç±»å‹
  - `sid`: æœåŠ¡å™¨ID
- **CENè´§å¸å¤„ç†**: å¦‚æœè´§å¸æ˜¯ `CEN`ï¼ˆç¾åˆ†ï¼‰ï¼Œåˆ™é™¤ä»¥100è½¬æ¢ä¸ºç¾å…ƒ
- **è¿‡æ»¤æ¡ä»¶**:
  - `userId > 0`: æ’é™¤ç³»ç»Ÿè´¦æˆ·
  - `sid IN (1, 5, 6)`: åªç»Ÿè®¡ç‰¹å®šæœåŠ¡å™¨çš„è´¦æˆ·
- **èšåˆ**: æŒ‰å®¢æˆ·IDåˆ†ç»„ï¼Œæ±‡æ€»åŒä¸€å®¢æˆ·æ‰€æœ‰è´¦æˆ·çš„å‡€å€¼

**è¾“å‡ºDataFrame**: `df_equity`
- åˆ—: `client_id`, `equity`

---

#### æ­¥éª¤2: æå–å†å²å…¥é‡‘ç»Ÿè®¡

```python
# --- Step 2: Deposit stats (history, deposit only) ---
print("ğŸ” [2/6] æ­£åœ¨æå–å®¢æˆ·å†å²å…¥é‡‘ç»Ÿè®¡ (stats_transactions)...")
deposit_sql = f"""
SELECT
    userId AS client_id,
    SUM(CASE WHEN type = 'deposit' THEN COALESCE(countTransactions, 0) ELSE 0 END) AS deposit_count,
    SUM(CASE WHEN UPPER(currency) = 'CEN' THEN amount / 100.0 ELSE amount END) AS deposit_sum,
    CASE
        WHEN SUM(CASE WHEN type = 'deposit' THEN COALESCE(countTransactions, 0) ELSE 0 END) = 0 THEN 0
        ELSE SUM(CASE WHEN UPPER(currency) = 'CEN' THEN amount / 100.0 ELSE amount END)
             / SUM(CASE WHEN type = 'deposit' THEN COALESCE(countTransactions, 0) ELSE 0 END)
    END AS deposit_avg
FROM {fxback_db}.stats_transactions
WHERE type = 'deposit'
  AND LEFT(loginSid, 2) != '2-'
GROUP BY userId
"""
df_deposit = pd.read_sql(deposit_sql, conn)
```

**SQLé€»è¾‘**:
- **æ•°æ®æº**: `stats_transactions` è¡¨ï¼ˆäº¤æ˜“ç»Ÿè®¡è¡¨ï¼‰
- **å­—æ®µè¯´æ˜**:
  - `type`: äº¤æ˜“ç±»å‹ï¼ˆè¿™é‡Œåªå– `deposit`ï¼‰
  - `countTransactions`: äº¤æ˜“æ¬¡æ•°
  - `amount`: äº¤æ˜“é‡‘é¢
  - `currency`: è´§å¸ç±»å‹
  - `loginSid`: ç™»å½•æœåŠ¡å™¨ID
- **è®¡ç®—å­—æ®µ**:
  - `deposit_count`: å…¥é‡‘æ€»æ¬¡æ•°
  - `deposit_sum`: å…¥é‡‘æ€»é‡‘é¢ï¼ˆCENè´§å¸é™¤ä»¥100ï¼‰
  - `deposit_avg`: å¹³å‡æ¯æ¬¡å…¥é‡‘é‡‘é¢ = æ€»é‡‘é¢ / æ€»æ¬¡æ•°
- **è¿‡æ»¤æ¡ä»¶**:
  - `type = 'deposit'`: åªç»Ÿè®¡å…¥é‡‘
  - `LEFT(loginSid, 2) != '2-'`: æ’é™¤2å·æœåŠ¡å™¨ï¼ˆå¯èƒ½æ˜¯IBé’±åŒ…ï¼‰

**è¾“å‡ºDataFrame**: `df_deposit`
- åˆ—: `client_id`, `deposit_count`, `deposit_sum`, `deposit_avg`

---

#### æ­¥éª¤3: æå–å†å²å‡€å…¥é‡‘

```python
# --- Step 3: Net deposit (history) ---
print("ğŸ” [3/6] æ­£åœ¨æå–å®¢æˆ·å†å²å‡€å…¥é‡‘ (stats_transactions)...")
tx_hist_sql = f"""
SELECT 
    userId AS client_id,
    SUM(CASE WHEN type = 'deposit' THEN (CASE WHEN UPPER(currency) = 'CEN' THEN amount / 100.0 ELSE amount END) ELSE 0 END) AS deposits_hist,
    SUM(CASE WHEN type = 'withdrawal' THEN (CASE WHEN UPPER(currency) = 'CEN' THEN amount / 100.0 ELSE amount END) ELSE 0 END) AS withdrawals_hist
FROM {fxback_db}.stats_transactions
WHERE type IN ('deposit', 'withdrawal')
  AND LEFT(loginSid, 2) != '2-'
GROUP BY userId
"""
df_tx_hist = pd.read_sql(tx_hist_sql, conn)
```

**SQLé€»è¾‘**:
- **æ•°æ®æº**: `stats_transactions` è¡¨
- **è®¡ç®—å­—æ®µ**:
  - `deposits_hist`: å†å²æ€»å…¥é‡‘é‡‘é¢ï¼ˆCENè´§å¸é™¤ä»¥100ï¼‰
  - `withdrawals_hist`: å†å²æ€»å‡ºé‡‘é‡‘é¢ï¼ˆCENè´§å¸é™¤ä»¥100ï¼‰
- **è¿‡æ»¤æ¡ä»¶**:
  - `type IN ('deposit', 'withdrawal')`: åŒ…å«å…¥é‡‘å’Œå‡ºé‡‘
  - `LEFT(loginSid, 2) != '2-'`: æ’é™¤2å·æœåŠ¡å™¨

**æ³¨æ„**: å‡ºé‡‘é‡‘é¢åœ¨æ•°æ®åº“ä¸­é€šå¸¸æ˜¯æ­£æ•°ï¼Œåç»­è®¡ç®—æ—¶ä¼šç”¨åŠ æ³•ï¼ˆå› ä¸ºå‡ºé‡‘æ˜¯è´Ÿæ•°æ¦‚å¿µï¼‰

**è¾“å‡ºDataFrame**: `df_tx_hist`
- åˆ—: `client_id`, `deposits_hist`, `withdrawals_hist`

---

#### æ­¥éª¤4: æå–å½“æœˆå‡€å…¥é‡‘

```python
# --- Step 4: Net deposit (current month) ---
print("ğŸ” [4/6] æ­£åœ¨æå–å®¢æˆ·å½“æœˆå‡€å…¥é‡‘ (stats_transactions)...")
tx_month_sql = f"""
SELECT 
    userId AS client_id,
    SUM(CASE WHEN type = 'deposit' THEN (CASE WHEN UPPER(currency) = 'CEN' THEN amount / 100.0 ELSE amount END) ELSE 0 END) AS deposits_month,
    SUM(CASE WHEN type = 'withdrawal' THEN (CASE WHEN UPPER(currency) = 'CEN' THEN amount / 100.0 ELSE amount END) ELSE 0 END) AS withdrawals_month
FROM {fxback_db}.stats_transactions
WHERE type IN ('deposit', 'withdrawal')
  AND LEFT(loginSid, 2) != '2-'
  AND date >= '{month_start_str}' AND date <= '{today_str}'
GROUP BY userId
"""
df_tx_month = pd.read_sql(tx_month_sql, conn)
```

**SQLé€»è¾‘**:
- **æ•°æ®æº**: `stats_transactions` è¡¨
- **æ—¶é—´èŒƒå›´**: ä»æœ¬æœˆ1å·åˆ°ä»Šå¤© (`date >= month_start_str AND date <= today_str`)
- **è®¡ç®—å­—æ®µ**:
  - `deposits_month`: å½“æœˆæ€»å…¥é‡‘
  - `withdrawals_month`: å½“æœˆæ€»å‡ºé‡‘

**è¾“å‡ºDataFrame**: `df_tx_month`
- åˆ—: `client_id`, `deposits_month`, `withdrawals_month`

---

#### æ­¥éª¤5: æå–å½“æœˆäº¤æ˜“åˆ©æ¶¦

```python
# --- Step 5: Month trade profit (client-level, CEN adjusted) ---
print("ğŸ” [5/6] æ­£åœ¨æå–å®¢æˆ·å½“æœˆäº¤æ˜“åˆ©æ¶¦ (mt4_trades)...")
trade_month_sql = f"""
SELECT
    mu.userId AS client_id,
    SUM(CASE WHEN mu.CURRENCY = 'CEN' THEN t.PROFIT / 100.0 ELSE t.PROFIT END) AS month_trade_profit
FROM {fxback_db}.mt4_trades t
INNER JOIN {fxback_db}.mt4_users mu ON t.loginSid = mu.loginSid
WHERE t.closeDate >= '{month_start_str}' AND t.closeDate <= '{today_str}'
  AND t.CMD IN (0, 1)
  AND mu.userId > 0
  AND mu.sid IN (1, 5, 6)
GROUP BY mu.userId
"""
df_trade_month = pd.read_sql(trade_month_sql, conn)
```

**SQLé€»è¾‘**:
- **æ•°æ®æº**: `mt4_trades` è¡¨ï¼ˆMT4äº¤æ˜“è®°å½•ï¼‰ + `mt4_users` è¡¨ï¼ˆå…³è”å®¢æˆ·ä¿¡æ¯ï¼‰
- **JOINæ¡ä»¶**: `t.loginSid = mu.loginSid`ï¼ˆé€šè¿‡ç™»å½•æœåŠ¡å™¨IDå…³è”ï¼‰
- **å­—æ®µè¯´æ˜**:
  - `PROFIT`: äº¤æ˜“åˆ©æ¶¦
  - `closeDate`: å¹³ä»“æ—¥æœŸ
  - `CMD`: è®¢å•ç±»å‹ï¼ˆ0=ä¹°å…¥, 1=å–å‡ºï¼‰
  - `CURRENCY`: è´§å¸ç±»å‹ï¼ˆä»mt4_usersè¡¨è·å–ï¼‰
- **è¿‡æ»¤æ¡ä»¶**:
  - `closeDate >= month_start_str AND closeDate <= today_str`: å½“æœˆå·²å¹³ä»“çš„äº¤æ˜“
  - `CMD IN (0, 1)`: åªç»Ÿè®¡ä¹°å–å•ï¼ˆæ’é™¤æŒ‚å•ã€ä¿®æ”¹å•ç­‰ï¼‰
  - `mu.userId > 0`: æ’é™¤ç³»ç»Ÿè´¦æˆ·
  - `mu.sid IN (1, 5, 6)`: åªç»Ÿè®¡ç‰¹å®šæœåŠ¡å™¨
- **CENè´§å¸å¤„ç†**: å¦‚æœå®¢æˆ·è´§å¸æ˜¯CENï¼Œåˆ©æ¶¦é™¤ä»¥100

**è¾“å‡ºDataFrame**: `df_trade_month`
- åˆ—: `client_id`, `month_trade_profit`

**é‡è¦**: è¿™æ˜¯åç»­åˆå¹¶çš„åŸºå‡†è¡¨ï¼Œåªæœ‰æœ¬æœˆæœ‰äº¤æ˜“çš„å®¢æˆ·æ‰ä¼šå‡ºç°åœ¨æœ€ç»ˆæŠ¥è¡¨ä¸­

---

#### æ­¥éª¤6: è¿‡æ»¤å‘˜å·¥è´¦æˆ·

```python
# --- Step 6: Employee filter (isEmployee = 0) ---
print("ğŸ” [6/7] æ­£åœ¨æå–éå‘˜å·¥å®¢æˆ· (users)...")
employee_sql = f"""
SELECT
    id AS client_id,
    COALESCE(isEmployee, 0) AS is_employee
FROM {fxback_db}.users
WHERE COALESCE(isEmployee, 0) = 0
"""
df_employee = pd.read_sql(employee_sql, conn)
```

**SQLé€»è¾‘**:
- **æ•°æ®æº**: `users` è¡¨ï¼ˆç”¨æˆ·ä¸»è¡¨ï¼‰
- **å­—æ®µè¯´æ˜**:
  - `id`: ç”¨æˆ·IDï¼ˆå¯¹åº”client_idï¼‰
  - `isEmployee`: æ˜¯å¦å‘˜å·¥ï¼ˆNULLè§†ä¸º0ï¼‰
- **è¿‡æ»¤æ¡ä»¶**: `COALESCE(isEmployee, 0) = 0`ï¼ˆåªä¿ç•™éå‘˜å·¥ï¼‰

**è¾“å‡ºDataFrame**: `df_employee`
- åˆ—: `client_id`, `is_employee`

---

#### æ­¥éª¤7: æ•°æ®åˆå¹¶ä¸æŒ‡æ ‡è®¡ç®—

##### 7.1 æ•°æ®åˆå¹¶

```python
# --- Step 7: Merge and compute metrics ---
print("ğŸ§  [7/7] æ­£åœ¨è¿›è¡Œå†…å­˜æ•°æ®åˆå¹¶ä¸æŒ‡æ ‡è®¡ç®—...")
# Base on active traders only (clients with trades this month)
df_final = pd.merge(df_trade_month, df_equity, on="client_id", how="left")
df_final = pd.merge(df_final, df_tx_hist, on="client_id", how="left")
df_final = pd.merge(df_final, df_tx_month, on="client_id", how="left")
df_final = pd.merge(df_final, df_deposit, on="client_id", how="left")
df_final = pd.merge(df_final, df_employee, on="client_id", how="inner")
df_final.fillna(0, inplace=True)
```

**åˆå¹¶é¡ºåº**:
1. `df_trade_month` (åŸºå‡†è¡¨) â† `df_equity` (å·¦è¿æ¥)
2. â† `df_tx_hist` (å·¦è¿æ¥)
3. â† `df_tx_month` (å·¦è¿æ¥)
4. â† `df_deposit` (å·¦è¿æ¥)
5. â† `df_employee` (å†…è¿æ¥ï¼Œè¿‡æ»¤å‘˜å·¥)

**è¿æ¥ç±»å‹è¯´æ˜**:
- `how="left"`: ä¿ç•™åŸºå‡†è¡¨çš„æ‰€æœ‰å®¢æˆ·ï¼Œå³ä½¿å…¶ä»–è¡¨æ²¡æœ‰æ•°æ®
- `how="inner"`: åªä¿ç•™ä¸¤ä¸ªè¡¨éƒ½æœ‰çš„å®¢æˆ·ï¼ˆè¿‡æ»¤å‘˜å·¥ï¼‰
- `fillna(0)`: å°†ç¼ºå¤±å€¼å¡«å……ä¸º0

**ç»“æœ**: åªæœ‰æœ¬æœˆæœ‰äº¤æ˜“ä¸”éå‘˜å·¥çš„å®¢æˆ·ä¼šå‡ºç°åœ¨æœ€ç»ˆæŠ¥è¡¨ä¸­

---

##### 7.2 è®¡ç®—åŸºç¡€æŒ‡æ ‡

```python
df_final["net_deposit_hist"] = (
    df_final["deposits_hist"] + df_final["withdrawals_hist"]
)
df_final["net_deposit_month"] = (
    df_final["deposits_month"] + df_final["withdrawals_month"]
)
df_final["profit_hist"] = df_final["equity"] - df_final["net_deposit_hist"]
```

**å…¬å¼è¯´æ˜**:

1. **å†å²å‡€å…¥é‡‘** (`net_deposit_hist`):
   ```
   net_deposit_hist = deposits_hist + withdrawals_hist
   ```
   - æ³¨æ„ï¼š`withdrawals_hist` åœ¨æ•°æ®åº“ä¸­å¯èƒ½æ˜¯æ­£æ•°ï¼Œä½†é€»è¾‘ä¸Šå‡ºé‡‘æ˜¯è´Ÿæ•°
   - å¦‚æœå‡ºé‡‘æ˜¯æ­£æ•°ï¼Œè¿™é‡Œç”¨åŠ æ³•æ˜¯æ­£ç¡®çš„ï¼ˆå› ä¸ºå‡ºé‡‘ä¼šå‡å°‘å‡€å…¥é‡‘ï¼‰

2. **å½“æœˆå‡€å…¥é‡‘** (`net_deposit_month`):
   ```
   net_deposit_month = deposits_month + withdrawals_month
   ```

3. **å†å²åˆ©æ¶¦** (`profit_hist`):
   ```
   profit_hist = equity - net_deposit_hist
   ```
   - å½“å‰å‡€å€¼ - å†å²å‡€å…¥é‡‘ = å†å²ç´¯è®¡åˆ©æ¶¦

---

##### 7.3 å…¥é‡‘é‡‘é¢åˆ†æ¡£

```python
# Bucket by average deposit amount
def bucket_deposit_avg(value):
    if value < 2000:
        return "0-2000"
    if value < 5000:
        return "2000-5000"
    if value < 50000:
        return "5000-50000"
    return "50000+"

df_final["deposit_avg_bucket"] = df_final["deposit_avg"].apply(
    bucket_deposit_avg
)
```

**åˆ†æ¡£è§„åˆ™**:
- `0-2000`: å¹³å‡å…¥é‡‘ < 2000
- `2000-5000`: 2000 â‰¤ å¹³å‡å…¥é‡‘ < 5000
- `5000-50000`: 5000 â‰¤ å¹³å‡å…¥é‡‘ < 50000
- `50000+`: å¹³å‡å…¥é‡‘ â‰¥ 50000

---

##### 7.4 Kå€¼æ˜ å°„ï¼ˆç”¨äºè°ƒæ•´åæ”¶ç›Šç‡ï¼‰

```python
# K mapping for adjusted return
def bucket_to_k(bucket):
    if bucket == "0-2000":
        return 2000
    if bucket == "2000-5000":
        return 5000
    if bucket == "5000-50000":
        return 50000
    return 60000

df_final["k_base"] = df_final["deposit_avg_bucket"].apply(bucket_to_k)
```

**Kå€¼æ˜ å°„è¡¨**:
| å¹³å‡å…¥é‡‘æ¡£ä½ | Kå€¼ |
|-------------|-----|
| 0-2000 | 2000 |
| 2000-5000 | 5000 |
| 5000-50000 | 50000 |
| 50000+ | 60000 |

**ç”¨é€”**: å½“å®¢æˆ·å†å²å‡€å…¥é‡‘ â‰¤ 0 æ—¶ï¼Œç”¨Kå€¼ä½œä¸ºåˆ†æ¯è®¡ç®—è°ƒæ•´åæ”¶ç›Šç‡

---

##### 7.5 æ”¶ç›Šç‡è®¡ç®—

```python
# Return metrics:
# - Non-adjusted: (equity - net_deposit_hist) / net_deposit_hist
# - Adjusted (net_deposit_hist <= 0): equity / K
def non_adjusted_return(row):
    if row["net_deposit_hist"] > 0:
        return (
            row["equity"] - row["net_deposit_hist"]
        ) / row["net_deposit_hist"] * 100
    return None

def adjusted_return(row):
    if row["net_deposit_hist"] <= 0:
        return row["equity"] / row["k_base"] * 100
    return None

df_final["return_non_adjusted"] = df_final.apply(non_adjusted_return, axis=1)
df_final["return_adjusted"] = df_final.apply(adjusted_return, axis=1)
```

**æ”¶ç›Šç‡å…¬å¼**:

1. **éè°ƒæ•´æ”¶ç›Šç‡** (`return_non_adjusted`):
   ```
   return_non_adjusted = (equity - net_deposit_hist) / net_deposit_hist * 100
   ```
   - **é€‚ç”¨æ¡ä»¶**: `net_deposit_hist > 0`ï¼ˆå†å²å‡€å…¥é‡‘ä¸ºæ­£ï¼‰
   - **å«ä¹‰**: å†å²åˆ©æ¶¦ / å†å²å‡€å…¥é‡‘ * 100%
   - **ç¤ºä¾‹**: å‡€å€¼10000ï¼Œå‡€å…¥é‡‘8000 â†’ (10000-8000)/8000 * 100 = 25%

2. **è°ƒæ•´åæ”¶ç›Šç‡** (`return_adjusted`):
   ```
   return_adjusted = equity / k_base * 100
   ```
   - **é€‚ç”¨æ¡ä»¶**: `net_deposit_hist <= 0`ï¼ˆå†å²å‡€å…¥é‡‘ä¸º0æˆ–è´Ÿï¼Œå³æœ¬é‡‘å·²å…¨éƒ¨å–å‡ºï¼‰
   - **å«ä¹‰**: å½“å‰å‡€å€¼ / Kå€¼ * 100%
   - **ç¤ºä¾‹**: å‡€å€¼5000ï¼Œæ¡£ä½æ˜¯2K-5Kï¼ˆK=5000ï¼‰ â†’ 5000/5000 * 100 = 100%

**ä¸šåŠ¡é€»è¾‘**: 
- å¦‚æœå®¢æˆ·è¿˜æœ‰æœ¬é‡‘åœ¨è´¦æˆ·ä¸­ï¼Œç”¨æ ‡å‡†æ”¶ç›Šç‡
- å¦‚æœå®¢æˆ·æœ¬é‡‘å·²å…¨éƒ¨å–å‡ºï¼Œç”¨è°ƒæ•´åæ”¶ç›Šç‡ï¼ˆé¿å…é™¤ä»¥0æˆ–è´Ÿæ•°ï¼‰

---

##### 7.6 åˆ†æ¡£æ”¶ç›Šç‡åˆ—å¡«å……

```python
# Only fill one adjusted column based on bucket
df_final["adj_0_2000"] = df_final.apply(
    lambda r: r["return_adjusted"]
    if r["deposit_avg_bucket"] == "0-2000"
    else None,
    axis=1,
)
df_final["adj_2000_5000"] = df_final.apply(
    lambda r: r["return_adjusted"]
    if r["deposit_avg_bucket"] == "2000-5000"
    else None,
    axis=1,
)
df_final["adj_5000_50000"] = df_final.apply(
    lambda r: r["return_adjusted"]
    if r["deposit_avg_bucket"] == "5000-50000"
    else None,
    axis=1,
)
df_final["adj_50000_plus"] = df_final.apply(
    lambda r: r["return_adjusted"]
    if r["deposit_avg_bucket"] == "50000+"
    else None,
    axis=1,
)
```

**é€»è¾‘è¯´æ˜**:
- æ ¹æ®å®¢æˆ·çš„å…¥é‡‘æ¡£ä½ï¼Œåªåœ¨å¯¹åº”çš„åˆ—å¡«å…¥è°ƒæ•´åæ”¶ç›Šç‡
- å…¶ä»–åˆ—ä¿æŒä¸º `None`
- **ç›®çš„**: æ–¹ä¾¿æŒ‰æ¡£ä½åˆ†ç»„ç»Ÿè®¡å’Œå±•ç¤º

**ç¤ºä¾‹**:
- å®¢æˆ·Aï¼ˆæ¡£ä½: 2K-5Kï¼‰â†’ `adj_2000_5000` æœ‰å€¼ï¼Œå…¶ä»–ä¸ºNone
- å®¢æˆ·Bï¼ˆæ¡£ä½: 50K+ï¼‰â†’ `adj_50000_plus` æœ‰å€¼ï¼Œå…¶ä»–ä¸ºNone

---

##### 7.7 CSVæ–‡ä»¶è¾“å‡º

```python
filename = f"account_pnl_with_client_metrics_v3_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
filepath = os.path.join(os.path.dirname(__file__), filename)

cols = [
    "client_id",
    "net_deposit_hist",
    "net_deposit_month",
    "equity",
    "profit_hist",
    "month_trade_profit",
    "adj_0_2000",
    "adj_2000_5000",
    "adj_5000_50000",
    "adj_50000_plus",
    "return_non_adjusted",
]

chinese_columns = {
    "client_id": "å®¢æˆ·ID",
    "net_deposit_hist": "å†å²å‡€å…¥é‡‘",
    "net_deposit_month": "å½“æœˆå‡€å…¥é‡‘",
    "equity": "ç°æ—¶è´¦æˆ·ä½™é¢",
    "profit_hist": "å†å²åˆ©æ¶¦",
    "month_trade_profit": "æœ¬æœˆåˆ©æ¶¦",
    "adj_0_2000": "è°ƒæ•´åæ”¶ç›Šç‡(2Kä»¥ä¸‹)%",
    "adj_2000_5000": "è°ƒæ•´åæ”¶ç›Šç‡(2K-5K)%",
    "adj_5000_50000": "è°ƒæ•´åæ”¶ç›Šç‡(5K-50K)%",
    "adj_50000_plus": "è°ƒæ•´åæ”¶ç›Šç‡(50Kä»¥ä¸Š)%",
    "return_non_adjusted": "éè°ƒæ•´æ”¶ç›Šç‡%",
}

df_final[cols].rename(columns=chinese_columns).to_csv(
    filepath, index=False, encoding="utf-8-sig"
)
```

**è¾“å‡ºè¯´æ˜**:
- **æ–‡ä»¶åæ ¼å¼**: `account_pnl_with_client_metrics_v3_YYYYMMDD_HHMMSS.csv`
- **ç¼–ç **: `utf-8-sig`ï¼ˆå¸¦BOMï¼ŒExcelå¯æ­£ç¡®è¯†åˆ«ä¸­æ–‡ï¼‰
- **åˆ—å**: ä½¿ç”¨ä¸­æ–‡åˆ—åï¼Œä¾¿äºé˜…è¯»
- **ç´¢å¼•**: ä¸è¾“å‡ºè¡Œç´¢å¼•

**CSVåˆ—è¯´æ˜**:
| åˆ—å | è¯´æ˜ |
|------|------|
| å®¢æˆ·ID | å®¢æˆ·å”¯ä¸€æ ‡è¯† |
| å†å²å‡€å…¥é‡‘ | ç´¯è®¡å…¥é‡‘ - ç´¯è®¡å‡ºé‡‘ |
| å½“æœˆå‡€å…¥é‡‘ | æœ¬æœˆå…¥é‡‘ - æœ¬æœˆå‡ºé‡‘ |
| ç°æ—¶è´¦æˆ·ä½™é¢ | å½“å‰è´¦æˆ·å‡€å€¼ |
| å†å²åˆ©æ¶¦ | å‡€å€¼ - å†å²å‡€å…¥é‡‘ |
| æœ¬æœˆåˆ©æ¶¦ | æœ¬æœˆäº¤æ˜“ç›ˆäº |
| è°ƒæ•´åæ”¶ç›Šç‡(2Kä»¥ä¸‹)% | 2Kä»¥ä¸‹æ¡£ä½çš„è°ƒæ•´åæ”¶ç›Šç‡ |
| è°ƒæ•´åæ”¶ç›Šç‡(2K-5K)% | 2K-5Kæ¡£ä½çš„è°ƒæ•´åæ”¶ç›Šç‡ |
| è°ƒæ•´åæ”¶ç›Šç‡(5K-50K)% | 5K-50Kæ¡£ä½çš„è°ƒæ•´åæ”¶ç›Šç‡ |
| è°ƒæ•´åæ”¶ç›Šç‡(50Kä»¥ä¸Š)% | 50Kä»¥ä¸Šæ¡£ä½çš„è°ƒæ•´åæ”¶ç›Šç‡ |
| éè°ƒæ•´æ”¶ç›Šç‡% | æ ‡å‡†æ”¶ç›Šç‡ |

---

## æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·æµè§ˆå™¨                                â”‚
â”‚                      (index.html)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTPè¯·æ±‚
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI WebæœåŠ¡å™¨                             â”‚
â”‚                        (app.py)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ GET /              â†’ è¿”å›å‰ç«¯é¡µé¢                        â”‚   â”‚
â”‚  â”‚ GET /api/files     â†’ åˆ—å‡ºæ‰€æœ‰CSVæ–‡ä»¶                     â”‚   â”‚
â”‚  â”‚ GET /api/file/{fn} â†’ ä¸‹è½½æŒ‡å®šCSVæ–‡ä»¶                     â”‚   â”‚
â”‚  â”‚ POST /api/run      â†’ è§¦å‘æ•°æ®æŸ¥è¯¢                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ subprocess.run()
                           â”‚ (æ‰§è¡ŒPythonè„šæœ¬)
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®æå–ä¸è®¡ç®—è„šæœ¬                              â”‚
â”‚              (fetch_mysql_pnl_v3.py)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 1: æŸ¥è¯¢ mt4_users â†’ å®¢æˆ·å®æ—¶å‡€å€¼                    â”‚   â”‚
â”‚  â”‚ Step 2: æŸ¥è¯¢ stats_transactions â†’ å†å²å…¥é‡‘ç»Ÿè®¡          â”‚   â”‚
â”‚  â”‚ Step 3: æŸ¥è¯¢ stats_transactions â†’ å†å²å‡€å…¥é‡‘            â”‚   â”‚
â”‚  â”‚ Step 4: æŸ¥è¯¢ stats_transactions â†’ å½“æœˆå‡€å…¥é‡‘             â”‚   â”‚
â”‚  â”‚ Step 5: æŸ¥è¯¢ mt4_trades â†’ å½“æœˆäº¤æ˜“åˆ©æ¶¦                   â”‚   â”‚
â”‚  â”‚ Step 6: æŸ¥è¯¢ users â†’ è¿‡æ»¤å‘˜å·¥è´¦æˆ·                        â”‚   â”‚
â”‚  â”‚ Step 7: æ•°æ®åˆå¹¶ + æŒ‡æ ‡è®¡ç®— â†’ ç”ŸæˆCSV                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ SQLæŸ¥è¯¢ (6æ¬¡)
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MySQLæ•°æ®åº“                                  â”‚
â”‚                  (fxbackoffice)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ mt4_users    â”‚  â”‚stats_trans-  â”‚  â”‚ mt4_trades   â”‚         â”‚
â”‚  â”‚              â”‚  â”‚  actions     â”‚  â”‚              â”‚         â”‚
â”‚  â”‚ - userId     â”‚  â”‚ - userId     â”‚  â”‚ - loginSid   â”‚         â”‚
â”‚  â”‚ - equity     â”‚  â”‚ - type       â”‚  â”‚ - PROFIT     â”‚         â”‚
â”‚  â”‚ - currency   â”‚  â”‚ - amount    â”‚  â”‚ - closeDate  â”‚         â”‚
â”‚  â”‚ - sid        â”‚  â”‚ - date      â”‚  â”‚ - CMD        â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚  â”‚ users        â”‚                                              â”‚
â”‚  â”‚ - id         â”‚                                              â”‚
â”‚  â”‚ - isEmployee â”‚                                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ è¿”å›DataFrame
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CSVæ–‡ä»¶è¾“å‡º                                    â”‚
â”‚  account_pnl_with_client_metrics_v3_YYYYMMDD_HHMMSS.csv        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å®¢æˆ·ID | å†å²å‡€å…¥é‡‘ | å½“æœˆå‡€å…¥é‡‘ | ç°æ—¶è´¦æˆ·ä½™é¢ | ...    â”‚   â”‚
â”‚  â”‚   123  |   8000    |    500     |    10000    | ...    â”‚   â”‚
â”‚  â”‚   456  |   5000    |   -200     |     6000    | ...    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®ä¸šåŠ¡é€»è¾‘è¯´æ˜

### 1. CENè´§å¸å¤„ç†

**é—®é¢˜**: CENï¼ˆç¾åˆ†ï¼‰è´§å¸å•ä½æ˜¯ç¾åˆ†ï¼Œéœ€è¦è½¬æ¢ä¸ºç¾å…ƒ

**å¤„ç†æ–¹å¼**: æ‰€æœ‰æ¶‰åŠCENè´§å¸çš„é‡‘é¢éƒ½é™¤ä»¥100
```python
CASE WHEN UPPER(currency) = 'CEN' THEN amount / 100.0 ELSE amount END
```

**ç¤ºä¾‹**:
- CENè´§å¸: 10000 ç¾åˆ† â†’ 100 ç¾å…ƒ
- USDè´§å¸: 10000 ç¾å…ƒ â†’ 10000 ç¾å…ƒ

---

### 2. è¿‡æ»¤æ¡ä»¶è¯¦è§£

#### 2.1 æœåŠ¡å™¨è¿‡æ»¤ (`sid IN (1, 5, 6)`)
- **ç›®çš„**: åªç»Ÿè®¡ç‰¹å®šMT4æœåŠ¡å™¨çš„è´¦æˆ·
- **æ’é™¤**: å…¶ä»–æœåŠ¡å™¨çš„è´¦æˆ·ï¼ˆå¯èƒ½æ˜¯æµ‹è¯•ç¯å¢ƒæˆ–ç‰¹æ®Šç”¨é€”ï¼‰

#### 2.2 IBé’±åŒ…è¿‡æ»¤ (`LEFT(loginSid, 2) != '2-'`)
- **ç›®çš„**: æ’é™¤2å·æœåŠ¡å™¨çš„è´¦æˆ·ï¼ˆå¯èƒ½æ˜¯IBé’±åŒ…ï¼‰
- **åŸå› **: IBé’±åŒ…çš„å…¥é‡‘å‡ºé‡‘ä¸åº”è¯¥è®¡å…¥å®¢æˆ·ç»Ÿè®¡

#### 2.3 å‘˜å·¥è´¦æˆ·è¿‡æ»¤ (`isEmployee = 0`)
- **ç›®çš„**: æ’é™¤å†…éƒ¨å‘˜å·¥è´¦æˆ·
- **åŸå› **: å‘˜å·¥è´¦æˆ·çš„äº¤æ˜“æ•°æ®ä¸åº”è¯¥è®¡å…¥å®¢æˆ·ç»Ÿè®¡

#### 2.4 ç³»ç»Ÿè´¦æˆ·è¿‡æ»¤ (`userId > 0`)
- **ç›®çš„**: æ’é™¤ç³»ç»Ÿè´¦æˆ·ï¼ˆuserId = 0æˆ–è´Ÿæ•°ï¼‰
- **åŸå› **: ç³»ç»Ÿè´¦æˆ·ä¸æ˜¯çœŸå®å®¢æˆ·

---

### 3. ä»¥æ´»è·ƒäº¤æ˜“è€…ä¸ºåŸºå‡†

**å…³é”®ä»£ç **:
```python
df_final = pd.merge(df_trade_month, df_equity, on="client_id", how="left")
```

**é€»è¾‘**: 
- ä»¥ `df_trade_month`ï¼ˆå½“æœˆæœ‰äº¤æ˜“çš„å®¢æˆ·ï¼‰ä½œä¸ºåŸºå‡†è¡¨
- å…¶ä»–æ•°æ®éƒ½å·¦è¿æ¥åˆ°è¿™ä¸ªåŸºå‡†è¡¨
- **ç»“æœ**: åªæœ‰æœ¬æœˆæœ‰äº¤æ˜“çš„å®¢æˆ·æ‰ä¼šå‡ºç°åœ¨æœ€ç»ˆæŠ¥è¡¨ä¸­

**ä¸šåŠ¡å«ä¹‰**: 
- åªç»Ÿè®¡æ´»è·ƒäº¤æ˜“å®¢æˆ·
- ä¸æ´»è·ƒçš„å®¢æˆ·ï¼ˆæœ¬æœˆæ— äº¤æ˜“ï¼‰ä¸çº³å…¥ç»Ÿè®¡

---

### 4. å‡€å…¥é‡‘è®¡ç®—é€»è¾‘

**å…¬å¼**:
```python
net_deposit_hist = deposits_hist + withdrawals_hist
```

**æ³¨æ„**: 
- å¦‚æœæ•°æ®åº“ä¸­ `withdrawals_hist` æ˜¯æ­£æ•°ï¼Œè¿™é‡Œç”¨åŠ æ³•æ˜¯æ­£ç¡®çš„
- å¦‚æœæ•°æ®åº“ä¸­ `withdrawals_hist` æ˜¯è´Ÿæ•°ï¼Œåº”è¯¥ç”¨å‡æ³•
- **éœ€è¦ç¡®è®¤**: æ•°æ®åº“ä¸­çš„ `withdrawals` å­—æ®µæ˜¯æ­£æ•°è¿˜æ˜¯è´Ÿæ•°

**ç¤ºä¾‹**:
- å…¥é‡‘: 10000ï¼Œå‡ºé‡‘: 2000ï¼ˆæ­£æ•°ï¼‰ â†’ å‡€å…¥é‡‘ = 10000 + 2000 = 12000 âŒï¼ˆé”™è¯¯ï¼‰
- å…¥é‡‘: 10000ï¼Œå‡ºé‡‘: -2000ï¼ˆè´Ÿæ•°ï¼‰ â†’ å‡€å…¥é‡‘ = 10000 + (-2000) = 8000 âœ…ï¼ˆæ­£ç¡®ï¼‰

**å»ºè®®**: æ£€æŸ¥æ•°æ®åº“ä¸­çš„ `withdrawals` å­—æ®µæ˜¯æ­£æ•°è¿˜æ˜¯è´Ÿæ•°ï¼Œå¦‚æœæ˜¯æ­£æ•°ï¼Œåº”è¯¥æ”¹ä¸ºå‡æ³•

---

### 5. æ”¶ç›Šç‡è®¡ç®—é€»è¾‘

#### 5.1 éè°ƒæ•´æ”¶ç›Šç‡
- **é€‚ç”¨**: å†å²å‡€å…¥é‡‘ > 0 çš„å®¢æˆ·
- **å…¬å¼**: `(å‡€å€¼ - å‡€å…¥é‡‘) / å‡€å…¥é‡‘ * 100`
- **å«ä¹‰**: æ ‡å‡†æ”¶ç›Šç‡ï¼Œåæ˜ ç›¸å¯¹äºæœ¬é‡‘çš„ç›ˆåˆ©ç™¾åˆ†æ¯”

#### 5.2 è°ƒæ•´åæ”¶ç›Šç‡
- **é€‚ç”¨**: å†å²å‡€å…¥é‡‘ â‰¤ 0 çš„å®¢æˆ·ï¼ˆæœ¬é‡‘å·²å…¨éƒ¨å–å‡ºï¼‰
- **å…¬å¼**: `å‡€å€¼ / Kå€¼ * 100`
- **å«ä¹‰**: ç”¨Kå€¼ä½œä¸ºåŸºå‡†ï¼Œé¿å…é™¤ä»¥0æˆ–è´Ÿæ•°
- **Kå€¼**: æ ¹æ®å®¢æˆ·å¹³å‡å…¥é‡‘æ¡£ä½ç¡®å®š

**ä¸šåŠ¡åœºæ™¯**:
- å®¢æˆ·A: å…¥é‡‘10000ï¼Œå‡ºé‡‘10000ï¼Œå‡€å€¼5000 â†’ ç”¨è°ƒæ•´åæ”¶ç›Šç‡
- å®¢æˆ·B: å…¥é‡‘10000ï¼Œå‡ºé‡‘2000ï¼Œå‡€å€¼12000 â†’ ç”¨éè°ƒæ•´æ”¶ç›Šç‡

---

### 6. æ•°æ®åˆå¹¶é¡ºåº

**åˆå¹¶é¡ºåº**:
1. `df_trade_month` â† `df_equity` (å·¦è¿æ¥)
2. â† `df_tx_hist` (å·¦è¿æ¥)
3. â† `df_tx_month` (å·¦è¿æ¥)
4. â† `df_deposit` (å·¦è¿æ¥)
5. â† `df_employee` (å†…è¿æ¥)

**ä¸ºä»€ä¹ˆæœ€åç”¨å†…è¿æ¥**:
- å†…è¿æ¥ä¼šè¿‡æ»¤æ‰ä¸åœ¨ `df_employee` ä¸­çš„å®¢æˆ·ï¼ˆå³å‘˜å·¥ï¼‰
- ç¡®ä¿æœ€ç»ˆç»“æœåªåŒ…å«éå‘˜å·¥å®¢æˆ·

---

### 7. ç¼ºå¤±å€¼å¤„ç†

```python
df_final.fillna(0, inplace=True)
```

**å¤„ç†æ–¹å¼**: å°†æ‰€æœ‰ç¼ºå¤±å€¼å¡«å……ä¸º0

**å½±å“**:
- å¦‚æœæŸä¸ªå®¢æˆ·æ²¡æœ‰å…¥é‡‘è®°å½•ï¼Œ`deposits_hist` ç­‰å­—æ®µä¼šæ˜¯0
- å¦‚æœæŸä¸ªå®¢æˆ·æ²¡æœ‰å‡€å€¼è®°å½•ï¼Œ`equity` ä¼šæ˜¯0
- **æ³¨æ„**: è¿™å¯èƒ½å¯¼è‡´è®¡ç®—é”™è¯¯ï¼ˆå¦‚é™¤ä»¥0ï¼‰

**å»ºè®®**: è€ƒè™‘å¯¹å…³é”®å­—æ®µï¼ˆå¦‚ `equity`ï¼‰è¿›è¡Œæ›´ç»†è‡´çš„å¤„ç†

---

## æ€»ç»“

æœ¬ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æ­¥éª¤ç”Ÿæˆå®¢æˆ·æ”¶ç›Šç‡æŠ¥è¡¨ï¼š

1. **æ•°æ®æå–**: ä»MySQLæ•°æ®åº“çš„4ä¸ªè¡¨ä¸­æå–6ç±»æ•°æ®
2. **æ•°æ®åˆå¹¶**: ä»¥æ´»è·ƒäº¤æ˜“è€…ä¸ºåŸºå‡†ï¼Œåˆå¹¶æ‰€æœ‰ç›¸å…³æ•°æ®
3. **æŒ‡æ ‡è®¡ç®—**: è®¡ç®—å‡€å…¥é‡‘ã€åˆ©æ¶¦ã€æ”¶ç›Šç‡ç­‰å…³é”®æŒ‡æ ‡
4. **åˆ†æ¡£å¤„ç†**: æ ¹æ®å¹³å‡å…¥é‡‘é‡‘é¢åˆ†æ¡£ï¼Œè®¡ç®—è°ƒæ•´åæ”¶ç›Šç‡
5. **æ–‡ä»¶è¾“å‡º**: ç”Ÿæˆå¸¦ä¸­æ–‡åˆ—åçš„CSVæ–‡ä»¶

**æ ¸å¿ƒç‰¹ç‚¹**:
- åªç»Ÿè®¡æ´»è·ƒäº¤æ˜“å®¢æˆ·
- æ’é™¤å‘˜å·¥è´¦æˆ·å’ŒIBé’±åŒ…
- æ”¯æŒCENè´§å¸è½¬æ¢
- åŒºåˆ†æ ‡å‡†æ”¶ç›Šç‡å’Œè°ƒæ•´åæ”¶ç›Šç‡
- æŒ‰å…¥é‡‘æ¡£ä½åˆ†ç»„å±•ç¤º

**æ³¨æ„äº‹é¡¹**:
- ç¡®è®¤æ•°æ®åº“ä¸­ `withdrawals` å­—æ®µçš„æ­£è´Ÿæ€§
- æ³¨æ„ç¼ºå¤±å€¼å¤„ç†å¯èƒ½å¯¼è‡´çš„è®¡ç®—é”™è¯¯
- æ—¶é—´èŒƒå›´åŸºäºå½“å‰æ—¥æœŸåŠ¨æ€è®¡ç®—
