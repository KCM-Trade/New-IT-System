<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Account PNL Data Viewer</title>

    <!--
    ============================================================
    Account PNL Data Viewer - Customer Profit/Loss Analysis Tool
    ============================================================
    
    PURPOSE:
    This page displays customer trading profit/loss data generated by
    fetch_mysql_pnl.py (or v2/v3 versions). It loads CSV files and 
    renders them in an interactive AG Grid table.
    
    HOW TO USE:
    1. Start the backend server: python app.py (runs on port 8111)
    2. Open browser: http://localhost:8111
    3. Select a CSV file from the dropdown (auto-loads latest)
    4. Use column filters, sorting, and pagination to explore data
    5. Click on Client ID to open CRM profile in new tab
    
    DATA SOURCE (from fetch_mysql_pnl_v3.py):
    The CSV files are generated by querying MySQL database with these conditions:
    
    QUERY CONDITIONS:
    ================
    1. mt4_users table (for equity):
       - userId > 0 (exclude invalid users)
       - sid IN (1, 5, 6) (live trading servers only, exclude demo)
       - CEN currency amounts divided by 100
    
    2. stats_transactions table (for deposits/withdrawals):
       - type IN ('deposit', 'withdrawal')
       - LEFT(loginSid, 2) != '2-' (exclude demo accounts, demo loginSid starts with '2-')
       - CEN currency amounts divided by 100
    
    3. mt4_trades table (for monthly trade profit):
       - CMD IN (0, 1) (0=Buy, 1=Sell orders only)
       - closeDate within current month
       - userId > 0, sid IN (1, 5, 6)
       - CEN currency amounts divided by 100
    
    4. users table (for employee filter):
       - COALESCE(isEmployee, 0) = 0 (exclude employee accounts)
    
    EXCLUDED ACCOUNTS:
    =================
    - Demo accounts: loginSid starts with '2-'
    - Employee accounts: isEmployee = 1
    - Invalid users: userId <= 0
    - Non-live servers: sid NOT IN (1, 5, 6)
    
    METRICS CALCULATION:
    ===================
    - net_deposit_hist = deposits_hist + withdrawals_hist (withdrawals are negative)
    - profit_hist = equity - net_deposit_hist
    - return_non_adjusted = (equity - net_deposit_hist) / net_deposit_hist * 100 (when net_deposit_hist > 0)
    - return_adjusted = equity / K * 100 (when net_deposit_hist <= 0)
      where K is based on deposit_avg bucket:
        - 0-2000: K = 2000
        - 2000-5000: K = 5000
        - 5000-50000: K = 50000
        - 50000+: K = 60000
    
    DEPENDENCIES:
    =============
    - AG Grid Community: Table rendering with sorting, filtering, pagination
    - PapaParse: CSV parsing library
    - Backend API (app.py):
      - GET /api/files - List available CSV files
      - GET /api/file/{filename} - Download specific CSV file
      - POST /api/run - Trigger new data generation
    ============================================================
    -->

    <!-- AG Grid CSS and JS for interactive table -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    
    <!-- PapaParse for CSV parsing in browser -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    
    <style>
      /* Basic page styling */
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        margin: 20px;
        background-color: #f8f9fa;
      }
      
      /* Header with title and status */
      .header {
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      /* AG Grid container - fixed height for scrolling */
      #myGrid {
        height: 600px;
        width: 100%;
      }
      
      /* File selection controls */
      .controls {
        margin-bottom: 10px;
      }
      select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      
      /* Status message area */
      .status {
        font-size: 14px;
        color: #666;
      }
      
      /* Column explanation panel at bottom */
      .column-notes {
        margin-top: 16px;
        padding: 12px;
        background: #ffffff;
        border: 1px solid #e1e5ea;
        border-radius: 6px;
      }
      .column-notes h3 {
        margin: 0 0 8px 0;
        font-size: 16px;
      }
      .column-notes ul {
        margin: 0;
        padding-left: 18px;
      }
      .column-notes li {
        margin: 4px 0;
        font-size: 13px;
        color: #444;
      }
    </style>
  </head>
  <body>
    <!-- Page Header -->
    <div class="header">
      <h1>1月客户交易Pnl数据</h1>
      <div class="status" id="status">Loading data...</div>
    </div>

    <!-- 
    File Selection Controls
    =======================
    - Dropdown lists all CSV files matching pattern: account_pnl_with_client_metrics_*.csv
    - Files are sorted by creation time (newest first)
    - Refresh button reloads the file list from server
    -->
    <div class="controls">
      <label for="csvSelect">Select Data File:</label>
      <select id="csvSelect" onchange="loadSelectedCsv()">
        <option value="">-- Select a CSV file --</option>
      </select>
      <button onclick="refreshFileList()">Refresh File List</button>
    </div>

    <!-- 
    AG Grid Container
    =================
    Uses ag-theme-alpine for styling. Features:
    - Sortable columns (click header)
    - Filterable columns (floating filter row)
    - Resizable columns (drag column borders)
    - Pagination (100 rows per page, configurable)
    -->
    <div id="myGrid" class="ag-theme-alpine"></div>
    
    <!-- 
    Column Notes Panel
    ==================
    Dynamically generated based on loaded CSV columns.
    Shows field name and explanation for each column.
    -->
    <div id="columnNotes" class="column-notes">
      <h3>字段说明</h3>
      <div>请选择或运行查询后展示字段说明。</div>
    </div>

    <script>
      // Global reference to AG Grid API for data manipulation
      let gridApi;

      /**
       * AG Grid Configuration
       * =====================
       * - columnDefs: Dynamically set when CSV is loaded
       * - defaultColDef: Default settings for all columns
       *   - sortable: Allow clicking header to sort
       *   - filter: Enable filter popup
       *   - resizable: Allow dragging column width
       *   - floatingFilter: Show filter input below header
       *   - flex: Columns share available space equally
       *   - minWidth: Minimum column width in pixels
       * - pagination: Enable pagination with page size options
       */
      const gridOptions = {
        columnDefs: [],
        defaultColDef: {
          sortable: true,
          filter: true,
          resizable: true,
          floatingFilter: true,
          flex: 1,
          minWidth: 100,
        },
        pagination: true,
        paginationPageSize: 100,
        paginationPageSizeSelector: [10, 50, 100, 500],
      };

      // Initialize AG Grid instance
      const gridDiv = document.querySelector("#myGrid");
      gridApi = agGrid.createGrid(gridDiv, gridOptions);

      /**
       * Refresh File List
       * =================
       * Fetches list of available CSV files from backend API.
       * API: GET /api/files
       * Response: [{ name: "filename.csv", date: "2026-01-30 10:00:00" }, ...]
       * 
       * Auto-loads the most recent file after fetching list.
       */
      async function refreshFileList() {
        document.getElementById("status").innerText = "Fetching file list...";
        try {
          const response = await fetch("/api/files");
          const files = await response.json();
          const select = document.getElementById("csvSelect");

          // Clear existing options except the first placeholder
          while (select.options.length > 1) {
            select.remove(1);
          }

          // Add each file as a dropdown option
          files.forEach((file) => {
            const option = document.createElement("option");
            option.value = file.name;
            option.text = `${file.name} (${file.date})`;
            select.add(option);
          });

          // Auto-load the first (most recent) file
          if (files.length > 0) {
            select.value = files[0].name;
            loadCsv(files[0].name);
          }
          document.getElementById("status").innerText =
            `Found ${files.length} files.`;
        } catch (error) {
          console.error("Error fetching files:", error);
          document.getElementById("status").innerText =
            "Error fetching file list. Are you running app.py?";
        }
      }

      /**
       * Load CSV File
       * =============
       * Downloads and parses a CSV file, then displays it in AG Grid.
       * Uses PapaParse library for robust CSV parsing.
       * 
       * @param {string} filename - Name of CSV file to load
       * 
       * API: GET /api/file/{filename}
       * 
       * Special handling:
       * - client_id/客户ID: Rendered as clickable link to CRM
       * - ID fields: Displayed as integers (no decimal places)
       * - Percentage fields: Displayed with % suffix
       * - Numeric fields: Formatted with thousands separator and 2 decimals
       */
      function loadCsv(filename) {
        const url = `/api/file/${filename}`;
        document.getElementById("status").innerText = `Loading ${filename}...`;
        
        Papa.parse(url, {
          download: true,      // Fetch from URL
          header: true,        // First row is column headers
          dynamicTyping: true, // Auto-convert numbers
          skipEmptyLines: true,
          complete: function (results) {
            if (results.errors.length > 0) {
              console.error("Errors:", results.errors);
              document.getElementById("status").innerText =
                "Error loading CSV. Check console.";
              return;
            }

            const data = results.data;
            if (data.length > 0) {
              /**
               * Column Comments Dictionary
               * ==========================
               * Maps column names to their explanations.
               * Supports both English and Chinese column names.
               * These are shown in tooltips and the notes panel.
               * 
               * Data Source Explanation:
               * - equity: SUM of mt4_users.equity (CEN/100) where sid IN (1,5,6)
               * - net_deposit_hist: SUM of deposits - withdrawals from stats_transactions
               * - month_trade_profit: SUM of mt4_trades.PROFIT for current month
               * - return rates: Calculated in Python based on deposit bucket logic
               */
              const columnComments = {
                // Client ID - links to CRM system
                client_id: "客户唯一标识 ID。",
                客户ID: "客户唯一标识 ID。",
                
                // Equity - current account value from mt4_users
                // Query: SUM(equity) WHERE userId > 0 AND sid IN (1,5,6)
                // CEN currency is divided by 100
                equity: "当前净值汇总（不含 IB wallet）。",
                当前净值: "当前净值汇总（不含 IB wallet）。",
                现时账户余额: "当前净值汇总（不含 IB wallet）。",
                
                // Net deposit history - from stats_transactions
                // Query: SUM(deposits) + SUM(withdrawals) WHERE LEFT(loginSid,2) != '2-'
                // Note: withdrawals are stored as negative values
                net_deposit_hist: "历史净入金（入金 + 出金）。",
                历史净入金: "历史净入金（入金 + 出金）。",
                net_deposit_hist_negative: "历史净入金是否为负，Y/N。",
                历史净入金为负: "历史净入金是否为负，Y/N。",
                
                // Net deposit for current month
                net_deposit_month: "当月净入金（本月入金 + 出金）。",
                当月净入金: "当月净入金（本月入金 + 出金）。",
                
                // Monthly trade profit - from mt4_trades
                // Query: SUM(PROFIT) WHERE CMD IN (0,1) AND closeDate in current month
                month_trade_profit: "本月交易利润（仅统计当月有交易的客户）。",
                本月交易利润: "本月交易利润（仅统计当月有交易的客户）。",
                本月利润: "本月交易利润（仅统计当月有交易的客户）。",
                
                // Adjusted return rates - calculated for clients with net_deposit <= 0
                // Formula: equity / K * 100, where K depends on average deposit bucket
                "调整后收益率(2K以下)%":
                  "净入金≤0 时，按 K=2000 计算 equity/K。",
                "调整后收益率(2K-5K)%":
                  "净入金≤0 时，按 K=5000 计算 equity/K。",
                "调整后收益率(5K-50K)%":
                  "净入金≤0 时，按 K=50000 计算 equity/K。",
                "调整后收益率(50K以上)%":
                  "净入金≤0 时，按 K=60000 计算 equity/K。",
                  
                // Non-adjusted return rate - for clients with net_deposit > 0
                // Formula: (equity - net_deposit_hist) / net_deposit_hist * 100
                "非调整收益率%":
                  "净入金>0 时，(equity-net)/net。",
                  
                // Historical profit - calculated in Python
                // Formula: equity - net_deposit_hist
                profit: "历史利润 = 当前净值 - 历史净入金。",
                历史利润: "历史利润 = 当前净值 - 历史净入金。",
                
                // Deposit statistics from stats_transactions
                deposit_count: "历史入金次数。",
                入金次数: "历史入金次数。",
                deposit_sum: "历史入金总额（CEN 已除 100）。",
                入金总额: "历史入金总额（CEN 已除 100）。",
                deposit_avg: "平均入金 = 入金总额 / 入金次数。",
                平均入金: "平均入金 = 入金总额 / 入金次数。",
                deposit_avg_bucket: "平均入金区间分组。",
                平均入金区间: "平均入金区间分组。",
                
                // Combined return rate
                return_rate:
                  "调整后收益率：净入金>0 用 (equity-net)/net，否则 equity/K。",
                调整后收益率:
                  "调整后收益率：净入金>0 用 (equity-net)/net，否则 equity/K。",
                "调整后收益率(%)":
                  "调整后收益率：净入金>0 用 (equity-net)/net，否则 equity/K。",
              };
              
              /**
               * ID Fields Set
               * =============
               * These fields should be displayed as integers, not formatted numbers.
               * Example: client_id 12345 should show as "12345", not "12,345.00"
               */
              const idFields = new Set([
                "account",
                "client_id",
                "sid",
                "loginSid",
                "login_sid",
                "deposit_count",
                "入金次数",
              ]);
              
              /**
               * Generate Column Definitions
               * ===========================
               * Creates AG Grid column config for each CSV column.
               * Includes:
               * - headerTooltip: Shows column explanation on hover
               * - cellRenderer: Custom rendering for client_id (CRM link)
               * - valueFormatter: Number formatting based on field type
               */
              const columns = Object.keys(data[0]).map((key) => ({
                field: key,
                // Convert snake_case to Title Case for display
                headerName: key
                  .split("_")
                  .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                  .join(" "),
                headerTooltip: columnComments[key] || "暂无说明。",
                
                // Special renderer for client_id - creates clickable CRM link
                cellRenderer:
                  key === "client_id" || key === "客户ID"
                    ? (params) => {
                        if (
                          params.value === null ||
                          params.value === undefined ||
                          params.value === ""
                        ) {
                          return "";
                        }
                        // Truncate to integer and build CRM URL
                        const clientId = Math.trunc(params.value);
                        const url = `https://mt4.kohleglobal.com/crm/users/${clientId}`;
                        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${clientId}</a>`;
                      }
                    : undefined,
                    
                // Number formatting based on field type
                valueFormatter: (params) => {
                  if (typeof params.value === "number") {
                    // ID fields: show as plain integer
                    if (idFields.has(key) || key.toLowerCase().endsWith("id")) {
                      return Number.isFinite(params.value)
                        ? Math.trunc(params.value).toString()
                        : params.value;
                    }
                    
                    // Percentage columns: add % suffix
                    const percentColumns = new Set([
                      "return_rate",
                      "调整后收益率",
                      "调整后收益率(%)",
                      "非调整收益率%",
                      "调整后收益率(2K以下)%",
                      "调整后收益率(2K-5K)%",
                      "调整后收益率(5K-50K)%",
                      "调整后收益率(50K以上)%",
                    ]);
                    if (
                      key.includes("multiplier") ||
                      key.includes("roi") ||
                      percentColumns.has(key)
                    ) {
                      return `${params.value.toFixed(2)}%`;
                    }
                    
                    // Default: format with thousands separator and 2 decimals
                    return params.value.toLocaleString(undefined, {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2,
                    });
                  }
                  return params.value;
                },
              }));
              
              // Apply column definitions and data to grid
              gridApi.setGridOption("columnDefs", columns);
              gridApi.setGridOption("rowData", data);
              
              // Update the column notes panel
              updateColumnNotes(columns, columnComments);
              
              document.getElementById("status").innerText =
                `Loaded ${data.length} rows from ${url}`;
            }
          },
        });
      }

      /**
       * Load Selected CSV
       * =================
       * Called when user selects a file from the dropdown.
       */
      function loadSelectedCsv() {
        const select = document.getElementById("csvSelect");
        if (select.value) {
          loadCsv(select.value);
        }
      }

      /**
       * Update Column Notes Panel
       * =========================
       * Generates the field explanation list at the bottom of the page.
       * Shows each column name with its description.
       */
      function updateColumnNotes(columns, columnComments) {
        const notes = document.getElementById("columnNotes");
        const items = columns
          .map((col) => {
            const name = col.headerName || col.field;
            const comment = columnComments[col.field] || "暂无说明。";
            return `<li><strong>${name}</strong>：${comment}</li>`;
          })
          .join("");
        notes.innerHTML = `<h3>字段说明</h3><ul>${items}</ul>`;
      }

      // Initialize: fetch file list and auto-load latest file
      refreshFileList();
    </script>
  </body>
</html>
