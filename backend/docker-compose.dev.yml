version: "3.9"

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: new-it-backend-dev
    working_dir: /app
    command: uvicorn main:app --reload --host 0.0.0.0 --port 8001
    ports:
      - "8001:8001"
    volumes:
      - .:/app
      # 将宿主机 frontend 目录挂载到容器 /frontend，便于服务把 JSON 写到 /frontend/public 并在宿主机可见
      - ../frontend:/frontend
      # 日志持久化：挂载到宿主机，容器重启/删除后日志仍保留
      - ./logs:/app/logs
    env_file:
      - .env
    environment:
      # 示例：在 .env 中配置真实值
      - PYTHONUNBUFFERED=1
      - REDIS_HOST=new-it-redis
      - REDIS_PORT=6379
    restart: unless-stopped
    depends_on:
      - redis
    # Docker 日志配置 (双保险：除了文件日志，Docker 也保留一份)
    logging:
      driver: "json-file"
      options:
        max-size: "50m"      # 单个日志文件最大 50MB
        max-file: "10"       # 保留 10 个文件 (约 500MB)
        compress: "true"     # 压缩旧日志节省空间


  redis:
    image: redis:7-alpine
    container_name: new-it-redis
    restart: unless-stopped
    # 内部通讯无需暴露端口到宿主机，更安全
